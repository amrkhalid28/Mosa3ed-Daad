<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>Ø£Ø¯Ø§Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙÙ†ÙŠØ© | Daad</title>

    <script src="https://cdn.tailwindcss.com" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root{ font-family: 'Cairo', sans-serif; }
        body{ background: radial-gradient(circle at center,#501323 0%,#3E0F1C 100%); min-height:100vh; color:#F2E8D8; }
        .animate-fade-in{ animation: fadeIn .28s ease both; } @keyframes fadeIn{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:translateY(0);} }
        .scrollbar-thin::-webkit-scrollbar{ width:8px; } .scrollbar-thin::-webkit-scrollbar-thumb{ background:#D5C5A0; border-radius:10px; }
        input,textarea,select{ background:#3E0F1C; color:#F2E8D8; border:1px solid #501323; transition:all .18s; }
        input:focus,textarea:focus,select:focus{ outline:none; box-shadow:0 0 0 2px rgba(213,197,160,0.18); border-color:#D5C5A0; }
        input[type="checkbox"]{ -webkit-appearance:none; appearance:none; width:1.5rem; height:1.5rem; border:2px solid #D5C5A0; background:#3E0F1C; display:grid; place-content:center; }
        input[type="checkbox"]::before{ content:""; width:.85rem; height:.85rem; transform:scale(0); transition:120ms; box-shadow:inset 1em 1em #501323; clip-path:polygon(14% 44%,0 65%,50% 100%,100% 16%,80% 0%,43% 62%); }
        input[type="checkbox"]:checked{ background:#D5C5A0; } input[type="checkbox"]:checked::before{ transform:scale(1); }
        .logo-float{ position:fixed; left:20px; bottom:20px; width:60px; height:60px; border-radius:50%; background:#3E0F1C; border:3px solid #E0D6BC; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 15px rgba(0,0,0,.5); z-index:50; }
        .modal-backdrop{ transition:opacity .28s, visibility .28s; }
        .chat-log{ height:450px; overflow-y:auto; scroll-behavior:smooth; }
        .chat-message{ max-width:85%; padding:12px; border-radius:12px; line-height:1.6; margin-bottom:10px; }
        .user-message{ background:#D5C5A0; color:#3E0F1C; align-self:flex-start; border-radius:12px 12px 0 12px; }
        .bot-message{ background:#3E0F1C; color:#F2E8D8; align-self:flex-end; border:1px solid #501323; border-radius:12px 12px 12px 0; }
        .loading-dots span{ width:8px; height:8px; background:#D5C5A0; border-radius:50%; display:inline-block; animation:bounce 1.4s infinite; margin:0 3px; }
        @keyframes bounce{ 0%,80%,100%{ transform:scale(0);} 40%{ transform:scale(1);} }
    </style>
</head>
<body class="antialiased selection:bg-accent-gold selection:text-dark-primary">

<main id="home-view" class="min-h-screen flex items-center justify-center p-6">
    <div class="max-w-4xl w-full animate-fade-in text-center">
        <img src="https://i.ibb.co/fz5m8DNf/imgi-102-cropped-cropped-logo-daad-2000x2000-1-1-700x700-removebg-preview.png" alt="Daad" class="mx-auto h-24 mb-6" />
        <h1 class="text-4xl font-bold text-accent-gold mb-4">Ø£Ø¯Ø§Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙÙ†ÙŠØ© | Daad</h1>
        <p class="mb-8 max-w-2xl mx-auto text-lg">Ø§Ø®ØªÙØ± Ù†Ù…Ø· Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ø¨Ø¯Ø£ Ø¨ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø«Ù… ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø³Ø§Ø¹Ø¯ Ø¶ Ø§Ù„Ø°ÙƒÙŠ.</p>
        <div class="flex gap-4 justify-center">
            <button id="btn-assistant" class="px-6 py-3 rounded-xl bg-accent-gold text-dark-primary font-bold">Ø§Ù„Ø§Ø³ØªØ¹Ø§Ù†Ø© Ø¨Ù…Ø³Ø§Ø¹Ø¯ Ø¶</button>
            <button id="btn-manual" class="px-6 py-3 rounded-xl bg-dark-secondary border border-accent-gold/30">Ø§Ù„Ø¨Ø¯Ø¡ ÙŠØ¯ÙˆÙŠØ§Ù‹</button>
        </div>
    </div>
</main>

<!-- Client Modal -->
<div id="client-info-modal" class="modal-backdrop fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" aria-hidden="true" style="display:none;">
    <div class="bg-dark-secondary rounded-xl p-6 max-w-2xl w-full" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-accent-gold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
            <button onclick="app.closeModal('client-info-modal')" aria-label="ØºÙ„Ù‚">Ã—</button>
        </div>
        <form id="client-info-form" onsubmit="event.preventDefault(); app.handleClientInfoSubmit();">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block mb-1 text-accent-gold">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ *</label><input id="client-name" required class="w-full p-3 rounded-lg" /></div>
                <div><label class="block mb-1 text-accent-gold">Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</label><input id="client-contact-phone" class="w-full p-3 rounded-lg" /></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                <div><label class="block mb-1 text-accent-gold">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±</label><input id="client-link" type="url" class="w-full p-3 rounded-lg" /></div>
                <div><label class="block mb-1 text-accent-gold">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³ÙˆØ´ÙŠØ§Ù„</label><input id="client-social-links" class="w-full p-3 rounded-lg" placeholder="Ø±ÙˆØ§Ø¨Ø· Ø£Ùˆ Ø­Ø³Ø§Ø¨Ø§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„"/></div>
            </div>
            <div class="mt-3"><label class="block mb-1 text-accent-gold">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label><input id="client-business-type" class="w-full p-3 rounded-lg" /></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                <div><label class="block mb-1 text-accent-gold">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label><input id="client-target-audience" class="w-full p-3 rounded-lg" /></div>
                <div><label class="block mb-1 text-accent-gold">Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†</label><input id="client-competitors" class="w-full p-3 rounded-lg" /></div>
            </div>
            <div class="mt-3"><label class="block mb-1 text-accent-gold">Ø£Ø¨Ø±Ø² Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</label><textarea id="client-challenges" rows="2" class="w-full p-3 rounded-lg"></textarea></div>
            <div class="mt-3"><label class="block mb-1 text-accent-gold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label><textarea id="client-additional-info" rows="2" class="w-full p-3 rounded-lg"></textarea></div>
            <div class="mt-4">
                <button id="save-client-info-btn" class="w-full py-3 rounded-xl bg-accent-gold text-dark-primary font-bold">Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
            </div>
        </form>
    </div>
</div>

<!-- AI Modal -->
<div id="ai-modal" class="modal-backdrop fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" aria-hidden="true" style="display:none;">
    <div class="bg-dark-secondary rounded-xl max-w-3xl w-full h-[85vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-4 border-b border-dark-primary bg-dark-primary/30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-accent-gold flex items-center justify-center">ğŸ¤–</div>
                <div><h3 class="text-accent-gold font-bold">Ù…Ø³Ø§Ø¹Ø¯ Ø¶</h3><div class="text-xs text-text-light/70">Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª</div></div>
            </div>
            <button onclick="app.closeModal('ai-modal')">Ã—</button>
        </div>

        <div id="chat-log" class="chat-log p-4 flex flex-col gap-3 bg-dark-primary/10"></div>

        <div class="p-4 border-t border-dark-primary bg-dark-secondary">
            <textarea id="chat-input" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." class="w-full p-4 rounded-xl resize-none" oninput="this.style.height=''; this.style.height = this.scrollHeight + 'px'"></textarea>
            <button id="chat-send-btn" class="mt-2 px-4 py-2 rounded-lg bg-accent-gold text-dark-primary font-bold" onclick="app.sendChatMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>
</div>

<a class="logo-float" href="https://wa.me/+966592136734" target="_blank" aria-label="ÙˆØ§ØªØ³Ø§Ø¨">
    <img src="https://i.ibb.co/fz5m8DNf/imgi-102-cropped-cropped-logo-daad-2000x2000-1-1-700x700-removebg-preview.png" style="width:48px;height:48px;object-fit:cover;" />
</a>

<script>
const app = (function(){
    const CONSTANTS = {
        URLS: {
            STORAGE: "https://script.google.com/macros/s/AKfycbw-6vu6Hbj-gcENg7Mv4q0MZLEYqs2WgceyY0miD4soWdrp1JxoEOgYYSBfI2Z9p0aV/exec",
            ASSISTANT: "https://script.google.com/macros/s/AKfycbwlvaIdSNqYgNLO182hDyEmMZi09EpKXfjJ999Nf4QLJ-zP38hiXN54SZgWwO2wStVb3A/exec"
        },
        KEYS: { CLIENT: 'daad_client_v2', PROPOSAL: 'daad_proposal_v2' },
        MAX_MONTHS: 12,
        TIMEOUT_MS: 30000
    };

    let state = { monthlySelections:[{}], visibleMonths:1, chatHistory:[], isAssistantMode:false };

    const $ = id => document.getElementById(id);
    const escapeHtml = str => (typeof str === 'string') ? str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;') : str;

    function openModalById(id){
        const el = $(id+'-modal') || $(id);
        if(!el) return;
        el.style.display = 'flex';
        el.setAttribute('aria-hidden','false');
    }
    function closeModal(id){
        const el = $(id+'-modal') || $(id);
        if(!el) return;
        el.style.display = 'none';
        el.setAttribute('aria-hidden','true');
    }

    function fillForm(info){
        if(!info) return;
        const map = { name:'client-name', phone:'client-contact-phone', link:'client-link', businessType:'client-business-type', targetAudience:'client-target-audience', competitors:'client-competitors', strategyGoal:'client-strategy-goal', budgetRange:'client-budget-range', socials:'client-social-links', challenges:'client-challenges', additionalInfo:'client-additional-info' };
        Object.keys(map).forEach(k => { const el = $(map[k]); if(el) el.value = info[k] || ''; });
    }

    function getFormInfo(){
        return {
            name: $('client-name').value.trim(),
            phone: $('client-contact-phone').value.trim(),
            link: $('client-link').value.trim(),
            businessType: $('client-business-type').value.trim(),
            targetAudience: $('client-target-audience').value.trim(),
            strategyGoal: $('client-strategy-goal') ? $('client-strategy-goal').value : '',
            budgetRange: $('client-budget-range') ? $('client-budget-range').value : '',
            competitors: $('client-competitors').value.trim(),
            socials: $('client-social-links').value.trim(),
            challenges: $('client-challenges').value.trim(),
            additionalInfo: $('client-additional-info').value.trim(),
            timestamp: new Date().toISOString()
        };
    }

    async function sendToStorage(data){
        try {
            const res = await fetch(CONSTANTS.URLS.STORAGE, { method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), keepalive:true });
            if(!res.ok) throw new Error('Storage response not OK: ' + res.status);
            return res;
        } catch(e) {
            // fallback to no-cors best-effort
            try {
                await fetch(CONSTANTS.URLS.STORAGE, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), keepalive:true });
                return { ok:true, fallback:true };
            } catch(err) { throw e; }
        }
    }

    // ===== ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯: ÙŠØ­Ø§ÙˆÙ„ CORS Ø«Ù… no-cors fallback ÙˆÙŠØ¹Ø·ÙŠ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¶Ø­Ø© =====
    async function callAssistantAPI(originalPayload){
        const controller = new AbortController();
        const timeoutId = setTimeout(()=>controller.abort(), CONSTANTS.TIMEOUT_MS);

        const client = originalPayload.clientInfo || {};
        const systemPrompt = `
Ø£Ù†Øª "Ù…Ø³Ø§Ø¹Ø¯ Ø¶Ø§Ø¯"ØŒ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ Ù„Ø´Ø±ÙƒØ© "Ø¶Ø§Ø¯".
Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©:
- Ø§Ù„Ø§Ø³Ù…: ${client.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- Ø§Ù„Ù†Ø´Ø§Ø·: ${client.businessType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- Ø§Ù„Ù‡Ø¯Ù: ${client.strategyGoal || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${client.budgetRange || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±: ${client.targetAudience || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª: ${client.challenges || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
Ø±Ø¯ Ù…Ø®ØªØµØ± ÙˆØ¹Ù…Ù„ÙŠØŒ ÙˆØ¥Ø°Ø§ Ø§Ø­ØªØ¬Øª ØªÙˆØ¶ÙŠØ­ Ø§Ø·Ù„Ø¨Ù‡.
        `;

        let contents = JSON.parse(JSON.stringify(originalPayload.history || []));
        if(contents.length > 0 && contents[0].role === 'user'){
            contents[0].parts[0].text = systemPrompt + "\n\n---\n\n" + contents[0].parts[0].text;
        } else if(contents.length === 0){
            contents = [{ role:"user", parts:[{ text: systemPrompt }] }];
        }

        const geminiBody = { contents };

        // Ù…Ø­Ø§ÙˆÙ„Ø© CORS
        try {
            const response = await fetch(CONSTANTS.URLS.ASSISTANT, {
                method:'POST', mode:'cors', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(geminiBody), signal: controller.signal, credentials:'omit'
            });
            clearTimeout(timeoutId);

            if(!response.ok){
                const errText = await response.text().catch(()=>'');
                try { const errJson = JSON.parse(errText||'{}'); if(errJson.error && errJson.error.message) throw new Error(errJson.error.message); } catch(e){}
                throw new Error(`Server Error: ${response.status} - ${errText || response.statusText}`);
            }

            const txt = await response.text();
            try {
                const json = JSON.parse(txt);
                return json.candidates?.[0]?.content?.parts?.[0]?.text || json.text || json.reply || JSON.stringify(json);
            } catch(e){
                return txt;
            }
        } catch(err){
            clearTimeout(timeoutId);
            console.error("Assistant fetch error:", err);
            if(err.name === 'AbortError') throw new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.');

            // fallback: try no-cors (won't be readable) â€” inform the user about CORS
            try {
                await fetch(CONSTANTS.URLS.ASSISTANT, {
                    method:'POST', mode:'no-cors', headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify(geminiBody), signal: controller.signal, keepalive:true
                });
                throw new Error('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„ÙƒÙ† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø¯ (opaque response). ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Access-Control-Allow-Origin Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.');
            } catch(fallbackErr){
                console.error('Fallback fetch failed:', fallbackErr);
                throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯. ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ø³Ø¨Ø¨: Ø³ÙŠØ§Ø³Ø© CORS Ø£Ùˆ Ø±Ø§Ø¨Ø· assistant ØºÙŠØ± Ù…Ù†Ø´ÙˆØ± Ù„Ù„Ø¬Ù…ÙŠØ¹. Ø±Ø§Ø¬Ø¹ Ù†Ø´Ø± Web App ÙˆØ£Ø¶Ù Ø±Ø¤ÙˆØ³ CORS.');
            }
        }
    }

    // UI helpers
    function addChatMsg(text, sender='bot', isLoading=false){
        const log = $('chat-log');
        const wrapper = document.createElement('div');
        wrapper.className = 'chat-message ' + (sender==='user' ? 'user-message' : 'bot-message');
        if(isLoading) wrapper.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
        else wrapper.innerHTML = escapeHtml(String(text)).replace(/\n/g,'<br>');
        log.appendChild(wrapper);
        log.scrollTop = log.scrollHeight;
    }
    function removeLoading(){ const l = document.querySelector('.loading-dots'); if(l) l.remove(); }

    // handlers
    async function handleClientInfoSubmit(){
        const info = getFormInfo();
        if(!info.name){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹'); $('client-name').focus(); return; }
        localStorage.setItem(CONSTANTS.KEYS.CLIENT, JSON.stringify(info));
        const btn = $('save-client-info-btn'); const original = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        try {
            await sendToStorage(info);
            closeModal('client-info-modal');
            if(state.isAssistantMode) openModalById('ai-modal');
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ù† Ø£Ù…ÙƒÙ†).');
        } catch(e){
            console.error('Storage error', e);
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙ„ÙƒÙ† ÙˆØ§Ø¬Ù‡Ù†Ø§ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ±.');
            closeModal('client-info-modal');
            if(state.isAssistantMode) openModalById('ai-modal');
        } finally {
            btn.disabled = false; btn.innerHTML = original;
        }
    }

    async function sendChatMessage(){
        const input = $('chat-input'); const txt = input.value.trim(); if(!txt) return;
        input.value=''; input.style.height='auto';
        addChatMsg(txt,'user');
        state.chatHistory.push({ role:'user', parts:[{ text: txt }] });
        addChatMsg('...', 'bot', true);
        try {
            const info = JSON.parse(localStorage.getItem(CONSTANTS.KEYS.CLIENT) || '{}');
            const reply = await callAssistantAPI({ history: state.chatHistory, clientInfo: info });
            removeLoading(); addChatMsg(reply,'bot'); state.chatHistory.push({ role:'model', parts:[{ text: reply }] });
        } catch(e){
            removeLoading(); addChatMsg('ğŸš« Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message, 'bot');
        }
    }

    // init & bindings
    function init(){
        // wire buttons
        $('btn-assistant').addEventListener('click', ()=>{ state.isAssistantMode=true; document.querySelector('main').style.display='none'; openModalById('client-info'); });
        $('btn-manual').addEventListener('click', ()=>{ alert('ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ â€” ØªØ­Øª Ø§Ù„ØªØ·ÙˆÙŠØ±'); });
        document.getElementById('client-info-modal').addEventListener('click', ()=> closeModal('client-info-modal'));
        document.getElementById('ai-modal').addEventListener('click', ()=> closeModal('ai-modal'));
        const saved = localStorage.getItem(CONSTANTS.KEYS.CLIENT); if(saved) fillForm(JSON.parse(saved));
        document.addEventListener('keydown', e => { if(e.key==='Escape'){ closeModal('ai-modal'); closeModal('client-info-modal'); } });
        $('chat-input').addEventListener('keypress', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChatMessage(); } });
    }

    return {
        init, openModal: openModalById, closeModal, handleClientInfoSubmit, sendChatMessage, sendToStorage, callAssistantAPI
    };
})();

document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>
